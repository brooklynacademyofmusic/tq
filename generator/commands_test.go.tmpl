{{ print "// Code generated by tq/generator; DO NOT EDIT." }}

package cmd

import (
	"testing"
    "regexp"
    "strings"

	"github.com/stretchr/testify/assert"
    "github.com/skysyzygy/tq/tq"
    "github.com/spf13/viper"
)

{{ $op := .op }}
{{- range $key, $commands := .commands }}
{{- range $commands }}
func Test_{{ print $op "_" $key "_" .Variant "_cmd" }}(t *testing.T) {
        command := {{ print $op "_" $key "_cmd" }}
        use := command.Use

        {{ if ne .Variant "" -}}
        flag := command.Flag("{{ .Variant }}")
        if flag != nil {
            flag.Value.Set("true")
            defer flag.Value.Set("false")
            use = flag.Usage
        }
        {{ end -}}

		input := strings.ReplaceAll(regexp.MustCompile(`\{.+\}$`).FindString(use),
                    ",...","")
        out, err := tq.CaptureOutput(func(){
            viper.Set("login",authString)
            // PreRun: tqInit
            command.PreRunE(command, nil)
            {{`//Use: {{ print $key " " $command.Usage }},`}}
            command.RunE(command, []string{input})
        })
    
        assert.Empty(t, string(err))
        // Note need to test output better
        assert.NotEmpty(t, string(out))
        
}
{{ end }}
{{- end }}